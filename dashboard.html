<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | FinanceMaster Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }
        
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--bg-secondary); border-radius: 1rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        
        .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    </style>
</head>
<body>
    <div id="app" class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 hidden lg:flex flex-col" style="background-color: #1e293b; color: #e2e8f0;">
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-chart-line text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">FinanceMaster</h1>
                        <p class="text-xs text-gray-400">Pro</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-home w-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" onclick="openModal('transaction-modal'); return false;" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700">
                    <i class="fas fa-plus-circle w-5"></i>
                    <span>Nova Transa√ß√£o</span>
                </a>
            </nav>
            
            <div class="p-4 border-t border-gray-700">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center text-white font-bold">
                        <span id="user-initial">U</span>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm" id="sidebar-user-name">Usu√°rio</p>
                        <p class="text-xs text-gray-400" id="sidebar-account-type">Pessoal</p>
                    </div>
                </div>
                <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg transition text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            <!-- Header -->
            <header class="card sticky top-0 z-50 px-4 md:px-6 py-4 flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center space-x-2 md:space-x-4 flex-1 min-w-0">
                    <button class="lg:hidden text-2xl flex-shrink-0">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="min-w-0">
                        <h2 class="text-xl md:text-2xl font-bold truncate">Dashboard</h2>
                        <p class="text-xs md:text-sm" style="color: var(--text-secondary);">Bem-vindo, <span id="header-user-name">Usu√°rio</span>!</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2 md:space-x-4">
                    <select id="period-filter" onchange="changePeriod(this.value)" class="card px-2 md:px-4 py-2 rounded-lg border focus:outline-none text-xs md:text-sm">
                        <option value="all">Todo Per√≠odo</option>
                        <option value="today">Hoje</option>
                        <option value="week">Esta Semana</option>
                        <option value="month" selected>Este M√™s</option>
                        <option value="year">Este Ano</option>
                    </select>
                    
                    <button onclick="toggleTheme()" class="card p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                        <i class="fas fa-moon" id="theme-icon"></i>
                    </button>
                </div>
            </header>

            <!-- Content -->
            <div class="p-4 md:p-6 space-y-4 md:space-y-6">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="card rounded-2xl p-6 border-l-4 border-emerald-500">
                        <p class="text-sm font-semibold uppercase" style="color: var(--text-secondary);">Receita Total</p>
                        <h3 class="text-3xl font-bold text-emerald-600 mt-2" id="total-income">R$ 0,00</h3>
                    </div>

                    <div class="card rounded-2xl p-6 border-l-4 border-red-500">
                        <p class="text-sm font-semibold uppercase" style="color: var(--text-secondary);">Despesas Totais</p>
                        <h3 class="text-3xl font-bold text-red-600 mt-2" id="total-expense">R$ 0,00</h3>
                    </div>

                    <div class="card rounded-2xl p-6 border-l-4 border-amber-500">
                        <p class="text-sm font-semibold uppercase" style="color: var(--text-secondary);">A Receber</p>
                        <h3 class="text-3xl font-bold text-amber-600 mt-2" id="total-pending">R$ 0,00</h3>
                    </div>

                    <div class="rounded-2xl p-6 bg-gradient-to-br from-emerald-500 to-emerald-600 text-white">
                        <p class="text-sm font-semibold uppercase">Saldo Real</p>
                        <h3 class="text-3xl font-bold mt-2" id="net-balance">R$ 0,00</h3>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card rounded-2xl p-6">
                        <h3 class="text-lg font-bold mb-4">Fluxo de Caixa</h3>
                        <div class="h-64">
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                    </div>

                    <div class="card rounded-2xl p-6">
                        <h3 class="text-lg font-bold mb-4">Despesas por Categoria</h3>
                        <div class="h-64">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Evolution -->
                <div class="card rounded-2xl p-6">
                    <h3 class="text-lg font-bold mb-4">Evolu√ß√£o Financeira</h3>
                    <div class="h-80">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>

                <!-- Transactions -->
                <div class="card rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">√öltimas Transa√ß√µes</h3>
                        <button onclick="openModal('transaction-modal')" class="text-sm bg-emerald-500 text-white px-4 py-2 rounded-lg hover:bg-emerald-600">
                            <i class="fas fa-plus mr-2"></i>Nova
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="border-b" style="border-color: var(--border-color);">
                                <tr class="text-left text-xs uppercase" style="color: var(--text-secondary);">
                                    <th class="pb-3">Descri√ß√£o</th>
                                    <th class="pb-3">Categoria</th>
                                    <th class="pb-3">Data</th>
                                    <th class="pb-3 text-right">Valor</th>
                                    <th class="pb-3 text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table" class="divide-y" style="border-color: var(--border-color);">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold">Nova Transa√ß√£o</h3>
                <button onclick="closeModal('transaction-modal')" class="text-2xl hover:text-red-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="transaction-form" onsubmit="saveTransaction(event);" class="space-y-4">
                <input type="hidden" id="transaction-id">
                
                <div>
                    <label class="block text-sm font-semibold mb-2">Descri√ß√£o</label>
                    <input type="text" id="transaction-desc" required placeholder="Ex: Sal√°rio, Aluguel..."
                        class="w-full px-4 py-3 border-2 rounded-xl focus:border-emerald-500 outline-none"
                        style="background-color: var(--bg-primary); border-color: var(--border-color);">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Valor (R$)</label>
                        <input type="number" id="transaction-amount" step="0.01" required placeholder="0,00"
                            class="w-full px-4 py-3 border-2 rounded-xl focus:border-emerald-500 outline-none"
                            style="background-color: var(--bg-primary); border-color: var(--border-color);">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">Data</label>
                        <input type="date" id="transaction-date" required
                            class="w-full px-4 py-3 border-2 rounded-xl focus:border-emerald-500 outline-none"
                            style="background-color: var(--bg-primary); border-color: var(--border-color);">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold mb-2">Tipo</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button type="button" class="type-btn active border-2 border-emerald-500 bg-emerald-50 text-emerald-700 py-3 rounded-xl font-semibold" data-type="income" onclick="selectType('income')">
                            <i class="fas fa-arrow-up mr-2"></i>Receita
                        </button>
                        <button type="button" class="type-btn border-2 border-gray-300 py-3 rounded-xl font-semibold" data-type="expense" onclick="selectType('expense')">
                            <i class="fas fa-arrow-down mr-2"></i>Despesa
                        </button>
                        <button type="button" class="type-btn border-2 border-gray-300 py-3 rounded-xl font-semibold" data-type="pending" onclick="selectType('pending')">
                            <i class="fas fa-clock mr-2"></i>A Receber
                        </button>
                    </div>
                    <input type="hidden" id="transaction-type" value="income">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold mb-2">Categoria</label>
                    <select id="transaction-category" required
                        class="w-full px-4 py-3 border-2 rounded-xl focus:border-emerald-500 outline-none"
                        style="background-color: var(--bg-primary); border-color: var(--border-color);">
                        <option value="">Selecione uma categoria</option>
                        <optgroup label="Receitas">
                            <option value="Sal√°rio">üíº Sal√°rio</option>
                            <option value="Freelance">üíª Freelance</option>
                            <option value="Investimentos">üìà Investimentos</option>
                        </optgroup>
                        <optgroup label="Despesas Fixas">
                            <option value="Moradia">üè† Moradia</option>
                            <option value="Transporte">üöó Transporte</option>
                            <option value="Educa√ß√£o">üìö Educa√ß√£o</option>
                        </optgroup>
                        <optgroup label="Despesas Vari√°veis">
                            <option value="Alimenta√ß√£o">üçΩÔ∏è Alimenta√ß√£o</option>
                            <option value="Lazer">üéÆ Lazer</option>
                            <option value="Compras">üõí Compras</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-bold py-4 rounded-xl hover:from-emerald-600 hover:to-emerald-700">
                        <i class="fas fa-save mr-2"></i>Salvar
                    </button>
                    <button type="button" onclick="closeModal('transaction-modal')" class="px-6 border-2 border-gray-300 rounded-xl hover:bg-gray-100">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURA√á√ÉO SUPABASE (CORRE√á√ÉO DE CONEX√ÉO)
        // ========================================
        const SUPABASE_URL = 'https://keklkdsiktkpbihhksro.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtla2xrZHNpa3RrcGJpaGhrc3JvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNjIxNzYsImV4cCI6MjA3ODgzODE3Nn0.Aadwh_qBeaZGUWYjh_DqxurPdPo2uwljHBLv-f51vAU';
        
        // Inicializa o cliente se ele n√£o existir
        if (!window.supabaseClient) {
            window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // ========================================
        // VARI√ÅVEIS GLOBAIS
        // ========================================
        let transactions = [];
        let currentUser = null;
        let userProfile = null;
        let currentPeriod = 'month';
        let charts = {};

        // ========================================
        // INICIALIZA√á√ÉO
        // ========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('‚úì P√°gina carregada');
            
            try {
                // Carregar tema
                loadTheme();
                
                // Carregar dados do usu√°rio
                await loadUserData();
                
                // Atualizar interface
                updateUserInfo();
                loadTransactions();
                setDefaultDate();
                updateDashboard();
                
                // Carregar gr√°ficos
                setTimeout(() => {
                    try {
                        updateCharts();
                    } catch (e) {
                        console.error('Erro em gr√°ficos:', e);
                    }
                }, 300);
                
                console.log('‚úì Dashboard pronto');
            } catch (error) {
                console.error('‚úó Erro:', error);
            }
        });

        // ========================================
        // AUTENTICA√á√ÉO
        // ========================================
        async function loadUserData() {
            try {
                if (!window.supabase) {
                    console.error('Supabase n√£o configurado corretamente');
                    return;
                }
                
                const { data: { session }, error } = await window.supabase.auth.getSession();
                
                if (error || !session) {
                    console.warn('Sess√£o expirada ou inexistente');
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = session.user;
                
                // Prioriza o nome vindo do metadata do banco
                userProfile = {
                    name: currentUser.user_metadata?.name || currentUser.email.split('@')[0],
                    accountType: currentUser.user_metadata?.account_type || 'pessoal'
                };
                
                // Backup local para persist√™ncia r√°pida
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                
                console.log('‚úì Usu√°rio autenticado:', userProfile.name);
            } catch (error) {
                console.error('‚úó Erro ao carregar usu√°rio:', error);
            }
        }

        // ========================================
        // USU√ÅRIO
        // ========================================
        function updateUserInfo() {
            if (!userProfile) return;
            
            const name = userProfile.name || 'Usu√°rio';
            const initial = name.charAt(0).toUpperCase();
            
            const els = {
                'user-initial': initial,
                'sidebar-user-name': name,
                'header-user-name': name.split(' ')[0],
                'sidebar-account-type': userProfile.accountType === 'pessoal' ? 'üë§ Pessoal' : 'üè¢ Empresarial'
            };
            
            Object.entries(els).forEach(([id, text]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            });
        }

        async function logout() {
            if (confirm('Deseja realmente sair?')) {
                try {
                    if (window.supabase) {
                        await window.supabase.auth.signOut();
                    }
                    // Limpeza total de seguran√ßa
                    localStorage.removeItem('userProfile');
                    localStorage.removeItem('sb-keklkdsiktkpbihhksro-auth-token'); 
                    window.location.href = 'login.html';
                } catch (e) {
                    console.error('Erro ao sair:', e);
                    window.location.href = 'login.html';
                }
            }
        }

        // ========================================
        // TRANSA√á√ïES
        // ========================================
        function loadTransactions() {
            if (!currentUser) return;
            
            // Chave √∫nica por usu√°rio para os dados n√£o se misturarem
            const key = 'finances_pro_' + currentUser.id;
            const data = localStorage.getItem(key);
            transactions = data ? JSON.parse(data) : [];
            console.log('‚úì Transa√ß√µes carregadas:', transactions.length);
        }

        function saveTransactions() {
            if (!currentUser) return;
            const key = 'finances_pro_' + currentUser.id;
            localStorage.setItem(key, JSON.stringify(transactions));
            
            // Aqui voc√™ poder√° adicionar no futuro: 
            // await supabase.from('transactions').upsert(...)
        }

        function saveTransaction(e) {
            e.preventDefault();
            
            const id = document.getElementById('transaction-id').value;
            const trans = {
                id: id ? parseInt(id) : Date.now(),
                desc: document.getElementById('transaction-desc').value,
                amount: parseFloat(document.getElementById('transaction-amount').value),
                date: document.getElementById('transaction-date').value,
                type: document.getElementById('transaction-type').value,
                category: document.getElementById('transaction-category').value,
                createdAt: id ? transactions.find(t => t.id === parseInt(id))?.createdAt : new Date().toISOString()
            };
            
            if (id) {
                const idx = transactions.findIndex(t => t.id === parseInt(id));
                if (idx !== -1) transactions[idx] = trans;
            } else {
                transactions.push(trans);
            }
            
            saveTransactions();
            updateDashboard();
            updateCharts();
            closeModal('transaction-modal');
            
            // Feedback visual em vez de alert travando a tela
            console.log('Transa√ß√£o salva!');
        }

        function deleteTransaction(id) {
            if (confirm('Excluir esta transa√ß√£o?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                updateDashboard();
                updateCharts();
            }
        }

        function editTransaction(id) {
            const t = transactions.find(x => x.id === id);
            if (!t) return;
            
            document.getElementById('transaction-id').value = t.id;
            document.getElementById('transaction-desc').value = t.desc;
            document.getElementById('transaction-amount').value = t.amount;
            document.getElementById('transaction-date').value = t.date;
            document.getElementById('transaction-type').value = t.type;
            document.getElementById('transaction-category').value = t.category;
            
            selectType(t.type);
            openModal('transaction-modal');
        }

        // ========================================
        // FILTROS
        // ========================================
        function changePeriod(period) {
            currentPeriod = period;
            updateDashboard();
            updateCharts();
        }

        function getFilteredTransactions() {
            if (!transactions) return [];
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            return transactions.filter(t => {
                const tDate = new Date(t.date + 'T00:00:00');
                
                switch (currentPeriod) {
                    case 'today':
                        return tDate >= today;
                    case 'week':
                        const week = new Date(today);
                        week.setDate(week.getDate() - 7);
                        return tDate >= week;
                    case 'month':
                        return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
                    case 'year':
                        return tDate.getFullYear() === now.getFullYear();
                    default:
                        return true;
                }
            });
        }

        function calculateTotals() {
            const filtered = getFilteredTransactions();
            
            const income = filtered.filter(t => t.type === 'income').reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
            const expense = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
            const pending = filtered.filter(t => t.type === 'pending').reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
            
            return { income, expense, pending, balance: income - expense };
        }

        function getCategoryData() {
            const filtered = getFilteredTransactions();
            const expenses = filtered.filter(t => t.type === 'expense');
            
            const cats = {};
            expenses.forEach(t => {
                cats[t.category] = (cats[t.category] || 0) + parseFloat(t.amount || 0);
            });
            
            return cats;
        }

        function getMonthlyEvolution() {
            const months = [];
            const income = [];
            const expense = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                
                const monthTrans = transactions.filter(t => {
                    const td = new Date(t.date + 'T00:00:00');
                    return td.getMonth() === date.getMonth() && td.getFullYear() === date.getFullYear();
                });
                
                const inc = monthTrans.filter(t => t.type === 'income').reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
                const exp = monthTrans.filter(t => t.type === 'expense').reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
                
                months.push(date.toLocaleDateString('pt-BR', { month: 'short' }));
                income.push(inc);
                expense.push(exp);
            }
            
            return { months, income, expense };
        }

        // ========================================
        // DASHBOARD
        // ========================================
        function updateDashboard() {
            const totals = calculateTotals();
            
            document.getElementById('total-income').textContent = formatCurrency(totals.income);
            document.getElementById('total-expense').textContent = formatCurrency(totals.expense);
            document.getElementById('total-pending').textContent = formatCurrency(totals.pending);
            document.getElementById('net-balance').textContent = formatCurrency(totals.balance);
            
            updateTransactionsTable();
        }

        function updateTransactionsTable() {
            const tbody = document.getElementById('transactions-table');
            if (!tbody) return;

            const filtered = getFilteredTransactions();
            const recent = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 opacity-50">Nenhuma transa√ß√£o encontrada para este per√≠odo.</td></tr>';
                return;
            }
            
            tbody.innerHTML = recent.map(t => `
                <tr class="border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                    <td class="py-4 px-2 text-sm font-medium">${t.desc}</td>
                    <td class="py-4 px-2 text-xs text-gray-500">${t.category}</td>
                    <td class="py-4 px-2 text-xs">${formatDate(t.date)}</td>
                    <td class="py-4 px-2 text-right font-bold text-sm ${t.type === 'income' ? 'text-emerald-600' : t.type === 'expense' ? 'text-red-600' : 'text-amber-600'}">
                        ${t.type === 'expense' ? '-' : '+'} ${formatCurrency(t.amount)}
                    </td>
                    <td class="py-4 px-2 text-center">
                        <div class="flex justify-center space-x-2">
                            <button onclick="editTransaction(${t.id})" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteTransaction(${t.id})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // ========================================
        // GR√ÅFICOS
        // ========================================
        function updateCharts() {
            updateCashFlowChart();
            updateCategoryChart();
            updateEvolutionChart();
        }

        function updateCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart');
            if (!ctx) return;
            
            const totals = calculateTotals();
            if (charts.cashFlow) charts.cashFlow.destroy();
            
            charts.cashFlow = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Receitas', 'Despesas', 'Pendente'],
                    datasets: [{
                        data: [totals.income, totals.expense, totals.pending],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;
            
            const cats = getCategoryData();
            if (charts.category) charts.category.destroy();
            
            const labels = Object.keys(cats);
            const data = Object.values(cats);
            
            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function updateEvolutionChart() {
            const ctx = document.getElementById('evolutionChart');
            if (!ctx) return;
            
            const evo = getMonthlyEvolution();
            if (charts.evolution) charts.evolution.destroy();
            
            charts.evolution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: evo.months,
                    datasets: [
                        { label: 'Receitas', data: evo.income, borderColor: '#10b981', tension: 0.3, fill: false },
                        { label: 'Despesas', data: evo.expense, borderColor: '#ef4444', tension: 0.3, fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // ========================================
        // MODAIS
        // ========================================
        function openModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('show');
                if (id === 'transaction-modal' && !document.getElementById('transaction-id').value) {
                    document.getElementById('transaction-form').reset();
                    setDefaultDate();
                    selectType('income');
                }
            }
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.classList.remove('show');
        }

        function selectType(type) {
            document.getElementById('transaction-type').value = type;
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active', 'border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
                if (btn.dataset.type === type) {
                    btn.classList.add('active', 'border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
                }
            });
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('transaction-date');
            if (dateInput) dateInput.value = today;
        }

        // ========================================
        // TEMA
        // ========================================
        function loadTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon(theme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            setTimeout(() => updateCharts(), 200);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            if (icon) icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // ========================================
        // UTILIT√ÅRIOS
        // ========================================
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        console.log('‚úì Scripts finalizados');
    </script>
</body>
</html>
